# @configure_input@
#
# $Id$
#
# Written by Keith Marshall <keithmarshall@users.sourceforge.net>
# Copyright (C) 2010, 2011, 2013, MinGW.org Project
#
#
# Makefile template for generating mingw-get distribution manifests.
#
#   Project: @PACKAGE_TARNAME@
#   Version: @PACKAGE_VERSION@
#
#
# This is free software.  Permission is granted to copy, modify and
# redistribute this software, under the provisions of the GNU General
# Public License, Version 3, (or, at your option, any later version),
# as published by the Free Software Foundation; see the file COPYING
# for licensing details.
#
# Note, in particular, that this software is provided "as is", in the
# hope that it may prove useful, but WITHOUT WARRANTY OF ANY KIND; not
# even an implied WARRANTY OF MERCHANTABILITY, nor of FITNESS FOR ANY
# PARTICULAR PURPOSE.  Under no circumstances will the author, or the
# MinGW Project, accept liability for any damages, however caused,
# arising from the use of this software.
#
all: @mingw_ac_subdirs@ update-references

@SET_MAKE@
@mingw_ac_subdirs@: FORCE
	@if test -r $@/Makefile; then \
	  cd $@; $(MAKE) $(MAKECMDGOALS); \
	  fi

.PHONY: FORCE
FORCE:

# We must list all goals which may be specified for sub-directories,
# so that they may be correctly passed through $(MAKECMDGOALS); at this
# level, the action for each is equivalent to that to be performed for
# the `all' goal.
#
all-distfiles: all

# To support optimised "mingw-get update", the package lists must be
# dynamically updated, to correctly identify the latest issue of each
# individual package catalogue file; the following rule, (which MUST
# be invoked at top level), creates a "sed" script which may then be
# paste the appropriate tags into the package list files.
#
ref = @top_srcdir@/*/
issue.sed: FORCE
	echo 's/issue=.*\(catalogue=\)/\\1/' > $@
	for tag in `sed -n '/.*catalogue="/{s///;s/".*//p;}' ${ref}*.xml`; \
	  do awk /$$tag'.xml$$/{ \
	       print "s/catalogue=\"'$$tag'\"/issue=\"" $$2 "\" &/" \
	     }' ${ref}issue.log; \
	  done >> $@

# The generated "sed" script must be applied iteratively, to each of
# the catalogue files which contains "package-list" references, until
# all cross references have been fully resolved...
#
update-references: FORCE
	echo check > issue.chk
	@while test x"`cat issue.chk`" != xclean; \
	  do echo clean > issue.chk; \
	     $(MAKE) update-local-references; \
	  done
	rm -f issue.chk

# ...considering all catalogues, in all registered sub-directories.
#
update-local-references: @mingw_ac_subdirs@

# $RCSfile$: end of file
